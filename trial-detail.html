<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VISIOR ‚Äî Trial Detail</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;0,9..40,800&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html,body,#root{width:100%;min-height:100vh;font-family:'DM Sans',sans-serif;background:#F2F6FC;color:#1A2840;scroll-behavior:smooth}
  ::-webkit-scrollbar{width:5px}
  ::-webkit-scrollbar-track{background:#F2F6FC}
  ::-webkit-scrollbar-thumb{background:#C5D3E8;border-radius:4px}

  @keyframes spin{to{transform:rotate(360deg)}}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 3px rgba(60,179,113,0.25)}50%{box-shadow:0 0 0 7px rgba(60,179,113,0.08)}}
  @keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
  @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
  @keyframes slideIn{from{opacity:0;transform:translateX(-12px)}to{opacity:1;transform:translateX(0)}}
  @keyframes modalIn{from{opacity:0;transform:scale(0.95) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
  @keyframes overlayIn{from{opacity:0}to{opacity:1}}

  .card{background:#fff;border-radius:14px;border:1px solid #E4ECF7;box-shadow:0 2px 16px rgba(69,103,183,0.07)}
  .section-label{font-size:10px;font-weight:700;letter-spacing:1.4px;text-transform:uppercase;color:#8FA0BA;margin-bottom:16px}
  
  .footer-links {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 30px;
    padding: 20px 0;
    border-top: 1px solid #E4ECF7;
  }

  .footer-links a {
    color: #8FA0BA;
    text-decoration: none;
    font-size: 12px;
    transition: color 0.2s;
  }

  .footer-links a:hover {
    color: #4567B7;
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

function ShieldLogo({ size=34 }) {
  return (
    <svg width={size} height={size*1.12} viewBox="0 0 36 40" fill="none">
      <path d="M18 2L2 9V21C2 30 9 37.5 18 39.5C27 37.5 34 30 34 21V9L18 2Z" fill="#4567B7"/>
      <path d="M18 2L2 9V21C2 30 9 37.5 18 39.5C27 37.5 34 30 34 21V9L18 2Z" stroke="#2C4E9E" strokeWidth="1" fill="none"/>
      <path d="M11 20L16 25.5L26 14" stroke="white" strokeWidth="2.4" strokeLinecap="round" strokeLinejoin="round"/>
    </svg>
  );
}

function LiveDot({ active, size=8 }) {
  return (
    <span style={{
      width:size, height:size, borderRadius:"50%",
      background: active ? "#3CB371" : "#bbb",
      display:"inline-block", flexShrink:0,
      boxShadow: active ? "0 0 0 3px rgba(60,179,113,0.22)" : "none",
      animation: active ? "pulse 2s infinite" : "none",
    }}/>
  );
}

function Spinner({ color="#4567B7", size=14 }) {
  return (
    <svg width={size} height={size} viewBox="0 0 14 14"
      style={{ animation:"spin 0.7s linear infinite", flexShrink:0 }}>
      <circle cx="7" cy="7" r="5" stroke={color} strokeWidth="2"
        fill="none" strokeDasharray="22" strokeDashoffset="6" opacity="0.85"/>
    </svg>
  );
}

const STATUS_CFG = {
  Recruiting: { bg:"#EAF6EA", color:"#256825", dot:"#3CB371" },
  Completed:  { bg:"#EBF0FA", color:"#2C4E9E", dot:"#4567B7" },
  Analysis:   { bg:"#FFF7E6", color:"#8B6000", dot:"#D4A017" },
};

function StatusBadge({ status }) {
  const c = STATUS_CFG[status] || STATUS_CFG.Completed;
  return (
    <span style={{
      display:"inline-flex", alignItems:"center", gap:6,
      background:c.bg, color:c.color,
      borderRadius:6, fontSize:11, fontWeight:700,
      letterSpacing:0.8, padding:"4px 12px", textTransform:"uppercase",
    }}>
      <span style={{ width:6, height:6, borderRadius:"50%", background:c.dot, flexShrink:0 }}/>
      {status}
    </span>
  );
}

function ContactModal({ researcher, onClose }) {
  const [form, setForm] = useState({ name:"", email:"", subject:"", message:"" });
  const [sending, setSending] = useState(false);
  const [sent, setSent] = useState(false);

  const handleSend = async (e) => {
    e.preventDefault();
    setSending(true);
    await new Promise(r => setTimeout(r, 1400));
    setSending(false);
    setSent(true);
  };

  return (
    <div onClick={onClose} style={{
      position:"fixed", inset:0, zIndex:1000,
      background:"rgba(10,20,40,0.55)", backdropFilter:"blur(4px)",
      display:"flex", alignItems:"center", justifyContent:"center",
      padding:24, animation:"overlayIn 0.2s ease",
    }}>
      <div onClick={e => e.stopPropagation()} style={{
        background:"white", borderRadius:16, width:"100%", maxWidth:520,
        boxShadow:"0 24px 80px rgba(10,20,40,0.22)",
        animation:"modalIn 0.25s ease", overflow:"hidden",
      }}>
        <div style={{ background:"linear-gradient(100deg,#0F1A2E,#1E3A6E)", padding:"20px 28px", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
          <div>
            <div style={{ color:"white", fontWeight:700, fontSize:15 }}>Contact Researcher</div>
            <div style={{ color:"rgba(255,255,255,0.5)", fontSize:11, marginTop:2 }}>{researcher?.name} ¬∑ {researcher?.institution}</div>
          </div>
          <button onClick={onClose} style={{ background:"rgba(255,255,255,0.1)", border:"none", borderRadius:8, width:32, height:32, cursor:"pointer", color:"white", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center" }}>√ó</button>
        </div>

        {sent ? (
          <div style={{ padding:"48px 28px", textAlign:"center" }}>
            <div style={{ fontSize:44, marginBottom:14 }}>‚úÖ</div>
            <div style={{ fontSize:16, fontWeight:700, color:"#1A2840", marginBottom:8 }}>Message Sent Successfully</div>
            <div style={{ fontSize:12, color:"#8FA0BA", lineHeight:1.7 }}>
              Your message has been delivered.
            </div>
            <button onClick={onClose} style={{ marginTop:24, padding:"9px 28px", borderRadius:9, background:"#4567B7", color:"white", border:"none", fontWeight:600, fontSize:13, cursor:"pointer" }}>Close</button>
          </div>
        ) : (
          <form onSubmit={handleSend} style={{ padding:"24px 28px" }}>
            {[
              { label:"Your Name",  key:"name",    type:"text",  placeholder:"Full name" },
              { label:"Your Email", key:"email",   type:"email", placeholder:"you@institution.edu" },
              { label:"Subject",    key:"subject", type:"text",  placeholder:"Regarding trial..." },
            ].map(f => (
              <div key={f.key} style={{ marginBottom:16 }}>
                <label style={{ display:"block", fontSize:11, fontWeight:700, color:"#6B82A8", letterSpacing:0.6, textTransform:"uppercase", marginBottom:6 }}>{f.label}</label>
                <input
                  type={f.type} value={form[f.key]} required
                  onChange={e => setForm({...form, [f.key]: e.target.value})}
                  placeholder={f.placeholder}
                  style={{ width:"100%", padding:"10px 14px", border:"1.5px solid #DDE8F5", borderRadius:9, fontSize:13, color:"#1A2840", outline:"none", fontFamily:"'DM Sans',sans-serif", background:"#F9FBFF" }}
                />
              </div>
            ))}
            <div style={{ marginBottom:20 }}>
              <label style={{ display:"block", fontSize:11, fontWeight:700, color:"#6B82A8", letterSpacing:0.6, textTransform:"uppercase", marginBottom:6 }}>Message</label>
              <textarea
                value={form.message} required rows={4}
                onChange={e => setForm({...form, message: e.target.value})}
                placeholder="Your message to the research team‚Ä¶"
                style={{ width:"100%", padding:"10px 14px", border:"1.5px solid #DDE8F5", borderRadius:9, fontSize:13, color:"#1A2840", outline:"none", fontFamily:"'DM Sans',sans-serif", background:"#F9FBFF", resize:"vertical" }}
              />
            </div>
            <div style={{ display:"flex", gap:10 }}>
              <button type="submit" disabled={sending} style={{ flex:1, padding:"11px", borderRadius:9, background:"#4567B7", color:"white", border:"none", fontWeight:600, fontSize:13, cursor: sending?"default":"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:8 }}>
                {sending ? <><Spinner color="white" size={13}/> Sending‚Ä¶</> : "Send Message"}
              </button>
              <button type="button" onClick={onClose} style={{ padding:"11px 20px", borderRadius:9, background:"white", border:"1.5px solid #DDE8F5", color:"#6B82A8", fontWeight:600, fontSize:13, cursor:"pointer" }}>Cancel</button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}

function AccessModal({ trialId, onClose }) {
  const [step, setStep] = useState(1);
  const [submitting, setSubmitting] = useState(false);
  const [form, setForm] = useState({ name:"", email:"", institution:"", role:"", reason:"" });

  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitting(true);
    await new Promise(r => setTimeout(r, 1600));
    setSubmitting(false);
    setStep(2);
    setTimeout(() => window.location.href = 'request-access.html', 2000);
  };

  return (
    <div onClick={onClose} style={{
      position:"fixed", inset:0, zIndex:1000,
      background:"rgba(10,20,40,0.55)", backdropFilter:"blur(4px)",
      display:"flex", alignItems:"center", justifyContent:"center",
      padding:24, animation:"overlayIn 0.2s ease",
    }}>
      <div onClick={e => e.stopPropagation()} style={{
        background:"white", borderRadius:16, width:"100%", maxWidth:560,
        boxShadow:"0 24px 80px rgba(10,20,40,0.22)",
        animation:"modalIn 0.25s ease", overflow:"hidden",
      }}>
        <div style={{ background:"linear-gradient(100deg,#0F1A2E,#1E3A6E)", padding:"20px 28px", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
          <div>
            <div style={{ color:"white", fontWeight:700, fontSize:15 }}>Request Full Access</div>
            <div style={{ color:"rgba(255,255,255,0.5)", fontSize:11, marginTop:2 }}>Trial {trialId}</div>
          </div>
          <button onClick={onClose} style={{ background:"rgba(255,255,255,0.1)", border:"none", borderRadius:8, width:32, height:32, cursor:"pointer", color:"white", fontSize:18, display:"flex", alignItems:"center", justifyContent:"center" }}>√ó</button>
        </div>

        {step === 2 ? (
          <div style={{ padding:"48px 28px", textAlign:"center" }}>
            <div style={{ fontSize:44, marginBottom:14 }}>üîê</div>
            <div style={{ fontSize:16, fontWeight:700, color:"#1A2840", marginBottom:8 }}>Redirecting to Request Form...</div>
          </div>
        ) : (
          <form onSubmit={handleSubmit} style={{ padding:"24px 28px" }}>
            <div style={{ background:"#FFF7E6", border:"1px solid #FFE0A0", borderRadius:9, padding:"12px 16px", marginBottom:20 }}>
              <p style={{ fontSize:12, color:"#8B6000", margin:0 }}>You'll be redirected to the detailed access request form.</p>
            </div>
            <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:14, marginBottom:14 }}>
              {[
                { label:"Full Name",    key:"name",        type:"text",  placeholder:"Dr. Jane Smith" },
                { label:"Email",        key:"email",       type:"email", placeholder:"you@institution.edu" },
                { label:"Institution",  key:"institution", type:"text",  placeholder:"University / Hospital" },
                { label:"Role / Title", key:"role",        type:"text",  placeholder:"e.g. Research Fellow" },
              ].map(f => (
                <div key={f.key}>
                  <label style={{ display:"block", fontSize:10, fontWeight:700, color:"#6B82A8", letterSpacing:0.6, textTransform:"uppercase", marginBottom:5 }}>{f.label}</label>
                  <input
                    type={f.type} value={form[f.key]} required
                    onChange={e => setForm({...form, [f.key]: e.target.value})}
                    placeholder={f.placeholder}
                    style={{ width:"100%", padding:"9px 13px", border:"1.5px solid #DDE8F5", borderRadius:8, fontSize:12, color:"#1A2840", outline:"none", background:"#F9FBFF" }}
                  />
                </div>
              ))}
            </div>
            <div style={{ marginBottom:20 }}>
              <label style={{ display:"block", fontSize:10, fontWeight:700, color:"#6B82A8", letterSpacing:0.6, textTransform:"uppercase", marginBottom:5 }}>Reason for Access</label>
              <textarea
                value={form.reason} required rows={3}
                onChange={e => setForm({...form, reason: e.target.value})}
                placeholder="Describe your research purpose..."
                style={{ width:"100%", padding:"9px 13px", border:"1.5px solid #DDE8F5", borderRadius:8, fontSize:12, color:"#1A2840", outline:"none", background:"#F9FBFF", resize:"vertical" }}
              />
            </div>
            <div style={{ display:"flex", gap:10 }}>
              <button type="submit" disabled={submitting} style={{ flex:1, padding:"11px", borderRadius:9, background:"#1A2840", color:"white", border:"none", fontWeight:600, fontSize:13, cursor: submitting?"default":"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:8 }}>
                {submitting ? <><Spinner color="white" size={13}/> Redirecting‚Ä¶</> : "Continue to Request Form"}
              </button>
              <button type="button" onClick={onClose} style={{ padding:"11px 20px", borderRadius:9, background:"white", border:"1.5px solid #DDE8F5", color:"#6B82A8", fontWeight:600, fontSize:13, cursor:"pointer" }}>Cancel</button>
            </div>
          </form>
        )}
      </div>
    </div>
  );
}

function BlockchainPanel({ trial }) {
  const [ts, setTs] = useState(timeAgo(trial?.lastVerified));
  const [refreshing, setRefreshing] = useState(false);
  const [verifyLoading, setVerifyLoading] = useState(false);

  useEffect(() => {
    const t = setInterval(() => setTs(timeAgo(trial?.lastVerified)), 5000);
    return () => clearInterval(t);
  }, [trial?.lastVerified]);

  const handleRefresh = async () => {
    setRefreshing(true);
    await new Promise(r => setTimeout(r, 1200));
    setRefreshing(false);
  };

  const handleVerify = async () => {
    setVerifyLoading(true);
    await new Promise(r => setTimeout(r, 1800));
    setVerifyLoading(false);
    window.open('https://etherscan.io', '_blank');
  };

  const isEth = trial?.blockchain?.network === "ethereum";

  return (
    <div style={{ background:"white", borderRadius:14, border:"1px solid #E4ECF7", boxShadow:"0 2px 16px rgba(69,103,183,0.07)", overflow:"hidden" }}>
      <div style={{ background:"linear-gradient(105deg,#0C1624 0%,#1A3060 100%)", padding:"18px 24px", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
        <div style={{ display:"flex", alignItems:"center", gap:12 }}>
          <div style={{ width:38, height:38, borderRadius:10, background:"rgba(255,255,255,0.08)", border:"1px solid rgba(255,255,255,0.12)", display:"flex", alignItems:"center", justifyContent:"center" }}>
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M3 7L10 3L17 7V13L10 17L3 13V7Z" stroke="rgba(255,255,255,0.75)" strokeWidth="1.3" fill="none"/>
            </svg>
          </div>
          <div>
            <div style={{ color:"white", fontWeight:700, fontSize:14 }}>Blockchain Verification</div>
            <div style={{ color:"rgba(255,255,255,0.45)", fontSize:10, letterSpacing:0.8, marginTop:1 }}>
              {isEth ? "ETHEREUM MAINNET" : "HYPERLEDGER FABRIC"}
            </div>
          </div>
        </div>
        <div style={{ display:"flex", alignItems:"center", gap:14 }}>
          <div style={{ display:"flex", alignItems:"center", gap:6 }}>
            <LiveDot active={trial?.connected} size={7}/>
            <span style={{ fontSize:10, color: trial?.connected ? "#3CB371" : "#bbb", fontWeight:700 }}>
              {trial?.connected ? "CONNECTED" : "OFFLINE"}
            </span>
          </div>
          <button onClick={handleRefresh} style={{ background:"rgba(255,255,255,0.08)", border:"1px solid rgba(255,255,255,0.14)", borderRadius:7, padding:"6px 12px", cursor:"pointer", fontSize:11, color:"rgba(255,255,255,0.7)", fontWeight:600, display:"flex", alignItems:"center", gap:5 }}>
            {refreshing ? <Spinner color="white" size={11}/> : "‚Üª"} Refresh
          </button>
        </div>
      </div>

      <div style={{ padding:"22px 24px" }}>
        <div style={{ background:"linear-gradient(100deg,#EDF3FC,#F7FAFF)", border:"1px solid #D5E2F8", borderRadius:10, padding:"14px 18px", marginBottom:20 }}>
          <div>
            <div style={{ fontSize:9, color:"#8FA0BA", fontWeight:700, letterSpacing:0.9, textTransform:"uppercase", marginBottom:4 }}>Data Integrity Hash</div>
            <div style={{ fontSize:12, fontFamily:"monospace", color:"#2C4E9E", fontWeight:600, wordBreak:"break-all" }}>{trial?.blockchain?.txHash || 'Pending'}</div>
          </div>
        </div>

        <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginBottom:20 }}>
          <ChainKv label="Network" value={trial?.blockchain?.network || 'Unknown'}/>
          <ChainKv label="Last Verified" value={ts}/>
        </div>

        <div style={{ display:"flex", gap:10 }}>
          <button onClick={handleVerify} style={{ flex:1, padding:"10px 18px", borderRadius:9, background:"linear-gradient(135deg,#4567B7,#2C4E9E)", color:"white", border:"none", fontWeight:600, fontSize:12, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:7 }}>
            {verifyLoading ? <Spinner color="white" size={13}/> : "üîç Verify on Explorer"}
          </button>
          <div style={{ flex:1, padding:"10px 18px", borderRadius:9, background:"#EAF6EA", border:"1px solid #B8E0C0", display:"flex", alignItems:"center", justifyContent:"center", gap:7 }}>
            <LiveDot active size={7}/>
            <span style={{ fontSize:12, color:"#256825", fontWeight:600 }}>Verified</span>
          </div>
        </div>
      </div>
    </div>
  );
}

function ChainKv({ label, value }) {
  return (
    <div style={{ background:"#F7FAFF", borderRadius:9, padding:"11px 13px", border:"1px solid #EDF2FB" }}>
      <div style={{ fontSize:9, color:"#8FA0BA", fontWeight:700, letterSpacing:0.7, textTransform:"uppercase", marginBottom:4 }}>{label}</div>
      <div style={{ fontSize:12, color:"#1A2840", fontWeight:600, wordBreak:"break-all" }}>{value || "‚Äî"}</div>
    </div>
  );
}

function ResultsBar({ label, value, color, delay }) {
  const [width, setWidth] = useState(0);
  useEffect(() => {
    const t = setTimeout(() => setWidth(value), 400 + delay);
    return () => clearTimeout(t);
  }, []);
  return (
    <div style={{ marginBottom:14 }}>
      <div style={{ display:"flex", justifyContent:"space-between", marginBottom:6 }}>
        <span style={{ fontSize:12, fontWeight:600, color:"#3A5070" }}>{label}</span>
        <span style={{ fontSize:13, fontWeight:800, color, fontFamily:"'Sora',sans-serif" }}>{value}%</span>
      </div>
      <div style={{ height:8, background:"#EDF2FB", borderRadius:100, overflow:"hidden" }}>
        <div style={{ height:"100%", width:`${width}%`, background:color, borderRadius:100, transition:"width 1s cubic-bezier(0.4,0,0.2,1)" }}/>
      </div>
    </div>
  );
}

function DocRow({ doc }) {
  const [downloading, setDownloading] = useState(false);
  const [done, setDone] = useState(false);
  const [hov, setHov] = useState(false);

  const handleDownload = async () => {
    setDownloading(true);
    await new Promise(r => setTimeout(r, 1400));
    setDownloading(false);
    setDone(true);
    setTimeout(() => setDone(false), 3000);
    alert(`Downloading ${doc?.name}`);
  };

  return (
    <div
      onMouseEnter={() => setHov(true)}
      onMouseLeave={() => setHov(false)}
      style={{ display:"flex", alignItems:"center", justifyContent:"space-between", padding:"14px 16px", background: hov ? "#F7FAFF" : "white", borderRadius:10, border:"1px solid #EDF2FB", transition:"background 0.18s", gap:12, flexWrap:"wrap" }}
    >
      <div style={{ display:"flex", alignItems:"center", gap:12 }}>
        <div style={{ width:38, height:38, borderRadius:9, background:"#EBF0FA", border:"1px solid #D5E2F8", display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0 }}>
          <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
            <rect x="3" y="2" width="12" height="14" rx="2" stroke="#4567B7" strokeWidth="1.3"/>
          </svg>
        </div>
        <div>
          <div style={{ fontSize:13, fontWeight:600, color:"#1A2840" }}>{doc?.name}</div>
          <div style={{ fontSize:10, color:"#8FA0BA", marginTop:2 }}>{doc?.type} ¬∑ {doc?.size}</div>
        </div>
      </div>
      <button onClick={handleDownload} style={{ padding:"7px 16px", borderRadius:8, border:"1.5px solid #BFCFE8", background:"white", fontSize:11, fontWeight:600, color: done ? "#256825" : "#4567B7", cursor: downloading ? "default" : "pointer", display:"flex", alignItems:"center", gap:6 }}>
        {downloading ? <><Spinner color="#4567B7" size={11}/> Verifying‚Ä¶</> : done ? "‚úì Downloaded" : "‚¨á Download"}
      </button>
    </div>
  );
}

function timeAgo(d) {
  if (!d) return 'Unknown';
  const s = Math.floor((Date.now() - new Date(d)) / 1000);
  if (s < 60) return `${s}s ago`;
  if (s < 3600) return `${Math.floor(s/60)}m ago`;
  return `${Math.floor(s/3600)}h ago`;
}

function fmtDate(str) {
  if (!str) return 'Unknown';
  return new Date(str).toLocaleDateString("en-GB", { day:"numeric", month:"long", year:"numeric" });
}

function App() {
  const [trial, setTrial] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [scrolled, setScrolled] = useState(false);
  const [showContact, setShowContact] = useState(false);
  const [showAccess, setShowAccess] = useState(false);
  const [liveTs, setLiveTs] = useState(new Date());

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const nctId = params.get('id') || 'NCT04280705'; // This one definitely work
    console.log('Trial ID from URL:', nctId);
    
    if (nctId) {
      fetchTrialDetails(nctId);
    } else {
      setError('No trial ID provided');
      setLoading(false);
    }
  }, []);

  const fetchTrialDetails = async (nctId) => {
  setLoading(true);
  setError(null);
  try {
    console.log('Fetching trial:', nctId);
    const response = await fetch(`http://localhost:3001/api/studies/${nctId}`);
    
    if (response.status === 404) {
      throw new Error(`Trial ID "${nctId}" not found in clinicaltrials.gov`);
    }
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Received data:', data);
    setTrial(data);
  } catch (error) {
    console.error('Error fetching trial:', error);
    setError(`Unable to load trial data: ${error.message}`);
  } finally {
    setLoading(false);
  }
};

  useEffect(() => {
    const poll = setInterval(() => {
      if (trial) {
        setTrial(prev => prev ? {...prev, lastVerified: new Date()} : prev);
      }
    }, 8000);
    
    const clock = setInterval(() => setLiveTs(new Date()), 1000);
    
    return () => {
      clearInterval(poll);
      clearInterval(clock);
    };
  }, [trial]);

  useEffect(() => {
    const fn = () => setScrolled(window.scrollY > 20);
    window.addEventListener("scroll", fn);
    return () => window.removeEventListener("scroll", fn);
  }, []);

  const SkeletonBlock = ({ h=18, w="100%", mb=10 }) => (
    <div style={{ height:h, width:w, borderRadius:6, marginBottom:mb, background:"linear-gradient(90deg,#f0f4fb 25%,#e4ecf8 50%,#f0f4fb 75%)", backgroundSize:"200% 100%", animation:"shimmer 1.6s infinite" }}/>
  );

  if (error) {
    return (
      <div style={{ minHeight:"100vh", display:"flex", alignItems:"center", justifyContent:"center", flexDirection:"column", gap:20 }}>
        <div style={{ fontSize:48 }}>‚ö†Ô∏è</div>
        <h2 style={{ color:"#1A2840" }}>{error}</h2>
        <button onClick={() => window.location.reload()} style={{ padding:"12px 24px", background:"#4567B7", color:"white", border:"none", borderRadius:8, cursor:"pointer" }}>
          Try Again
        </button>
        <a href="home.html" style={{ color:"#4567B7" }}>‚Üê Back to Home</a>
      </div>
    );
  }

  if (loading) {
    return (
      <div style={{ minHeight:"100vh", width:"100%", background:"#F2F6FC" }}>
        <nav style={{ position:"fixed", top:0, left:0, right:0, zIndex:200, background:"white", borderBottom:"1px solid #EDF2FB", padding:"0 40px", height:66, display:"flex", alignItems:"center", justifyContent:"space-between" }}>
          <ShieldLogo size={32}/>
          <div>Loading...</div>
        </nav>
        <main style={{ maxWidth:1440, margin:"0 auto", padding:"100px 40px" }}>
          <SkeletonBlock h={30} w="60%" mb={20}/>
          <SkeletonBlock h={200} w="100%" mb={20}/>
          <SkeletonBlock h={150} w="100%"/>
        </main>
      </div>
    );
  }

  return (
    <div style={{ minHeight:"100vh", width:"100%", background:"#F2F6FC" }}>
      {/* Header */}
      <nav style={{
        position:"fixed", top:0, left:0, right:0, zIndex:200,
        background: scrolled ? "rgba(255,255,255,0.97)" : "white",
        backdropFilter: scrolled ? "blur(14px)" : "none",
        borderBottom:`1px solid ${scrolled ? "#DDE8F5" : "#EDF2FB"}`,
        boxShadow: scrolled ? "0 2px 24px rgba(69,103,183,0.10)" : "none",
        transition:"all 0.3s ease",
      }}>
        <div style={{ maxWidth:1440, margin:"0 auto", padding:"0 40px", height:66, display:"flex", alignItems:"center", justifyContent:"space-between" }}>
          <a href="home.html" style={{ display:"flex", alignItems:"center", gap:12, textDecoration:"none" }}>
            <ShieldLogo size={32}/>
            <div>
              <div style={{ fontSize:20, fontWeight:800, color:"#1A2840", letterSpacing:-0.6, lineHeight:1, fontFamily:"'Sora',sans-serif" }}>
                WIS<span style={{ color:"#4567B7" }}>ER</span>
              </div>
              <div style={{ fontSize:9, color:"#8FA0BA", letterSpacing:1.5, fontWeight:600, textTransform:"uppercase" }}>Secure Clinical Trials</div>
            </div>
          </a>

          <div style={{ display:"flex", alignItems:"center", gap:8, background:"#F4F7FC", borderRadius:8, padding:"6px 14px", border:"1px solid #E4ECF7" }}>
            <LiveDot active size={6}/>
            <span style={{ fontSize:11, color:"#6B82A8", fontWeight:600, fontFamily:"monospace", letterSpacing:0.3 }}>
              {liveTs.toISOString().replace("T"," ").slice(0,19)} UTC
            </span>
          </div>

          <div style={{ display:"flex", gap:10 }}>
            <a href="login.html" style={{ padding:"8px 20px", borderRadius:9, border:"1.5px solid #D0DCF0", fontSize:13, fontWeight:600, color:"#4567B7", textDecoration:"none", background:"white" }}>Sign In</a>
            <a href="register.html" style={{ padding:"8px 20px", borderRadius:9, border:"none", fontSize:13, fontWeight:600, color:"white", textDecoration:"none", background:"linear-gradient(135deg,#4567B7,#2C4E9E)" }}>Register</a>
          </div>
        </div>
      </nav>

      {/* Breadcrumb */}
      <div style={{ paddingTop:66, background:"white", borderBottom:"1px solid #EDF2FB" }}>
        <div style={{ maxWidth:1440, margin:"0 auto", padding:"12px 40px", display:"flex", alignItems:"center", justifyContent:"space-between" }}>
          <div style={{ display:"flex", alignItems:"center", gap:8, fontSize:12, color:"#8FA0BA" }}>
            <a href="home.html" style={{ color:"#4567B7", textDecoration:"none", fontWeight:600 }}>VISIOR</a>
            <span>‚Ä∫</span>
            <a href="home.html" style={{ color:"#8FA0BA", textDecoration:"none" }}>Search Results</a>
            <span>‚Ä∫</span>
            <span style={{ color:"#1A2840", fontWeight:600 }}>{trial?.id}</span>
          </div>
          <a href="home.html" style={{ display:"flex", alignItems:"center", gap:6, fontSize:12, fontWeight:600, color:"#4567B7", textDecoration:"none", padding:"6px 14px", border:"1.5px solid #D5E2F8", borderRadius:8, background:"#F7FAFF" }}>‚Üê Back to Search Results</a>
        </div>
      </div>

      {/* Public View Banner */}
      <div style={{ background:"linear-gradient(100deg,#4567B7,#2C4E9E)", padding:"11px 40px" }}>
        <div style={{ maxWidth:1440, margin:"0 auto", display:"flex", alignItems:"center", gap:10 }}>
          <span style={{ fontSize:14 }}>üîì</span>
          <p style={{ fontSize:12, color:"rgba(255,255,255,0.9)", fontWeight:500 }}>
            <strong style={{ color:"white" }}>Public View ‚Äî </strong>
            You are viewing publicly available blockchain-verified information.
          </p>
        </div>
      </div>

      {/* Main Content */}
      <main style={{ maxWidth:1440, margin:"0 auto", padding:"36px 40px 100px" }}>
        <div style={{ display:"grid", gridTemplateColumns:"1fr 400px", gap:28, alignItems:"start" }}>
          {/* Left Column */}
          <div style={{ display:"flex", flexDirection:"column", gap:22 }}>
            {/* Title Card */}
            <div className="card" style={{ padding:"28px 32px" }}>
              <div style={{ display:"flex", alignItems:"center", gap:10, marginBottom:18, flexWrap:"wrap" }}>
                <StatusBadge status={trial?.status}/>
                <span style={{ background:"#F4F7FC", color:"#4567B7", borderRadius:6, fontSize:10, fontWeight:700, letterSpacing:0.8, padding:"4px 10px", textTransform:"uppercase", border:"1px solid #D5E2F8" }}>{trial?.phase}</span>
                <span style={{ background:"#F4F7FC", color:"#6B82A8", borderRadius:6, fontSize:10, fontWeight:700, letterSpacing:0.8, padding:"4px 10px", textTransform:"uppercase", border:"1px solid #E4ECF7" }}>{trial?.id}</span>
                <div style={{ marginLeft:"auto", display:"flex", alignItems:"center", gap:5 }}>
                  <LiveDot active size={6}/>
                  <span style={{ fontSize:10, color:"#3CB371", fontWeight:700 }}>LIVE DATA</span>
                </div>
              </div>

              <h1 style={{ fontSize:"clamp(18px,2.2vw,26px)", fontWeight:800, color:"#1A2840", lineHeight:1.35, marginBottom:18, fontFamily:"'Sora',sans-serif", letterSpacing:-0.5 }}>
                {trial?.title}
              </h1>

              <div style={{ display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:12 }}>
                {[
                  { l:"Posted",       v: fmtDate(trial?.posted) },
                  { l:"Last Updated", v: timeAgo(trial?.lastUpdated) },
                  { l:"Disease Area", v: trial?.disease },
                  { l:"Intervention", v: trial?.drug },
                ].map(m => (
                  <div key={m.l} style={{ background:"#F7FAFF", borderRadius:9, padding:"10px 12px", border:"1px solid #EDF2FB" }}>
                    <div style={{ fontSize:9, color:"#8FA0BA", fontWeight:700, letterSpacing:0.7, textTransform:"uppercase", marginBottom:3 }}>{m.l}</div>
                    <div style={{ fontSize:12, fontWeight:600, color:"#1A2840", lineHeight:1.4 }}>{m.v}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Summary Card */}
            <div className="card" style={{ padding:"26px 28px" }}>
              <div className="section-label">üìÑ Study Summary</div>
              <p style={{ fontSize:13.5, color:"#3A5070", lineHeight:1.8, margin:0 }}>{trial?.summary}</p>
            </div>

            {/* Results Card */}
            <div className="card" style={{ padding:"26px 28px" }}>
              <div className="section-label">üìä Key Results</div>

              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:20, marginBottom:24 }}>
                <div style={{ background:"linear-gradient(135deg,#EAF6EA,#F0FBF0)", borderRadius:12, padding:"18px 20px", border:"1px solid #C8E8CC" }}>
                  <div style={{ fontSize:10, color:"#256825", fontWeight:700, letterSpacing:0.8, textTransform:"uppercase", marginBottom:6 }}>Treatment Group</div>
                  <div style={{ fontSize:40, fontWeight:800, color:"#256825", fontFamily:"'Sora',sans-serif", lineHeight:1 }}>{trial?.results?.treatmentEffectiveness || 0}%</div>
                </div>
                <div style={{ background:"linear-gradient(135deg,#F7F4FB,#F0ECFB)", borderRadius:12, padding:"18px 20px", border:"1px solid #D5C8EC" }}>
                  <div style={{ fontSize:10, color:"#6B4FCF", fontWeight:700, letterSpacing:0.8, textTransform:"uppercase", marginBottom:6 }}>Placebo Group</div>
                  <div style={{ fontSize:40, fontWeight:800, color:"#6B4FCF", fontFamily:"'Sora',sans-serif", lineHeight:1 }}>{trial?.results?.placeboEffectiveness || 0}%</div>
                </div>
              </div>

              <ResultsBar label="Treatment Effectiveness" value={trial?.results?.treatmentEffectiveness || 0} color="#3CB371" delay={0}/>
              <ResultsBar label="Placebo Effectiveness"   value={trial?.results?.placeboEffectiveness || 0}   color="#9B7FDF" delay={150}/>

              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:18, marginTop:22 }}>
                <div>
                  <div style={{ fontSize:10, color:"#8FA0BA", fontWeight:700, letterSpacing:0.8, textTransform:"uppercase", marginBottom:12 }}>Primary Outcomes</div>
                  {trial?.results?.primaryOutcomes?.map((o,i) => (
                    <div key={i} style={{ display:"flex", gap:8, alignItems:"flex-start", marginBottom:10 }}>
                      <span style={{ width:16, height:16, borderRadius:"50%", background:"#EAF6EA", border:"1.5px solid #B8DFC0", display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0, marginTop:1 }}>
                        <span style={{ fontSize:9, color:"#256825", fontWeight:700 }}>‚úì</span>
                      </span>
                      <span style={{ fontSize:12, color:"#3A5070", lineHeight:1.55 }}>{o}</span>
                    </div>
                  )) || <p>No data available</p>}
                </div>

                <div>
                  <div style={{ fontSize:10, color:"#8FA0BA", fontWeight:700, letterSpacing:0.8, textTransform:"uppercase", marginBottom:12 }}>Side Effects</div>
                  {trial?.results?.sideEffects?.map((s,i) => (
                    <div key={i} style={{ display:"flex", gap:8, alignItems:"center", marginBottom:8 }}>
                      <span style={{ width:6, height:6, borderRadius:"50%", background:"#D4A017", flexShrink:0 }}/>
                      <span style={{ fontSize:12, color:"#3A5070" }}>{s}</span>
                    </div>
                  )) || <p>No data available</p>}
                </div>
              </div>
            </div>

            {/* Eligibility Card */}
            <div className="card" style={{ padding:"26px 28px" }}>
              <div className="section-label">üìã Eligibility Criteria</div>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:20 }}>
                <div>
                  <div style={{ display:"flex", alignItems:"center", gap:7, marginBottom:14 }}>
                    <div style={{ width:20, height:20, borderRadius:6, background:"#EAF6EA", border:"1.5px solid #B8DFC0", display:"flex", alignItems:"center", justifyContent:"center" }}>
                      <span style={{ fontSize:10, color:"#256825" }}>‚úì</span>
                    </div>
                    <span style={{ fontSize:11, fontWeight:700, color:"#256825", letterSpacing:0.5, textTransform:"uppercase" }}>Inclusion</span>
                  </div>
                  {trial?.eligibility?.inclusion?.map((c,i) => (
                    <div key={i} style={{ display:"flex", gap:9, alignItems:"flex-start", marginBottom:10 }}>
                      <span style={{ fontSize:10, color:"#3CB371", fontWeight:700, marginTop:2, flexShrink:0 }}>{i+1}.</span>
                      <span style={{ fontSize:12, color:"#3A5070", lineHeight:1.6 }}>{c}</span>
                    </div>
                  )) || <p>No criteria available</p>}
                </div>

                <div>
                  <div style={{ display:"flex", alignItems:"center", gap:7, marginBottom:14 }}>
                    <div style={{ width:20, height:20, borderRadius:6, background:"#FEF0F0", border:"1.5px solid #FACACA", display:"flex", alignItems:"center", justifyContent:"center" }}>
                      <span style={{ fontSize:10, color:"#C0392B" }}>‚úï</span>
                    </div>
                    <span style={{ fontSize:11, fontWeight:700, color:"#C0392B", letterSpacing:0.5, textTransform:"uppercase" }}>Exclusion</span>
                  </div>
                  {trial?.eligibility?.exclusion?.map((c,i) => (
                    <div key={i} style={{ display:"flex", gap:9, alignItems:"flex-start", marginBottom:10 }}>
                      <span style={{ fontSize:10, color:"#E05050", fontWeight:700, marginTop:2, flexShrink:0 }}>{i+1}.</span>
                      <span style={{ fontSize:12, color:"#3A5070", lineHeight:1.6 }}>{c}</span>
                    </div>
                  )) || <p>No criteria available</p>}
                </div>
              </div>
            </div>

            {/* Documents Card */}
            <div className="card" style={{ padding:"26px 28px" }}>
              <div className="section-label">üìÇ Public Documents</div>
              <div style={{ display:"flex", flexDirection:"column", gap:10 }}>
                {trial?.documents?.map((doc,i) => <DocRow key={i} doc={doc}/>) || <p>No documents available</p>}
              </div>
            </div>
          </div>

          {/* Right Column - Sticky */}
          <div style={{ display:"flex", flexDirection:"column", gap:22, position:"sticky", top:80 }}>
            {/* PI Card */}
            <div className="card" style={{ padding:"22px 22px" }}>
              <div className="section-label">üë©‚Äç‚öïÔ∏è Principal Investigator</div>
              <div style={{ display:"flex", gap:14, alignItems:"flex-start", marginBottom:18 }}>
                <div style={{ width:52, height:52, borderRadius:14, background:"linear-gradient(135deg,#4567B7,#2C4E9E)", display:"flex", alignItems:"center", justifyContent:"center", flexShrink:0 }}>
                  <span style={{ color:"white", fontSize:18, fontWeight:700 }}>
                    {trial?.researcher?.name?.replace(/^(Dr\.|Prof\.)\s*/,"").split(" ").slice(0,2).map(w=>w[0]).join("") || 'PI'}
                  </span>
                </div>
                <div>
                  <div style={{ fontSize:14, fontWeight:700, color:"#1A2840" }}>{trial?.researcher?.name || 'Principal Investigator'}</div>
                  <div style={{ fontSize:11, color:"#4567B7", fontWeight:600, marginTop:2 }}>{trial?.researcher?.title}</div>
                  <div style={{ fontSize:11, color:"#8FA0BA", marginTop:3 }}>{trial?.researcher?.institution}</div>
                </div>
              </div>
              <button onClick={() => setShowContact(true)} style={{ width:"100%", padding:"9px 0", borderRadius:8, border:"1.5px solid #BFCFE8", background:"transparent", color:"#4567B7", fontSize:12, fontWeight:600, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:7 }}>
                ‚úâ Contact Researcher
              </button>
            </div>

            {/* Sponsor Card */}
            <div className="card" style={{ padding:"20px 22px" }}>
              <div className="section-label">üè¢ Sponsor</div>
              <p style={{ fontSize:13, fontWeight:600, color:"#1A2840", lineHeight:1.55 }}>{trial?.sponsor || 'Unknown'}</p>
            </div>

            {/* Trial Scale Card */}
            <div className="card" style={{ padding:"20px 22px" }}>
              <div className="section-label">üë• Trial Scale</div>
              <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:10 }}>
                {[
                  { l:"Total Enrolled", v: trial?.results?.totalPatients?.toLocaleString() || 'Unknown' },
                  { l:"Phase",          v: trial?.phase || 'Unknown' },
                  { l:"Disease",        v: trial?.disease || 'Unknown' },
                  { l:"Status",         v: trial?.status || 'Unknown' },
                ].map(m => (
                  <div key={m.l} style={{ background:"#F7FAFF", borderRadius:8, padding:"10px 12px", border:"1px solid #EDF2FB" }}>
                    <div style={{ fontSize:9, color:"#8FA0BA", fontWeight:700, letterSpacing:0.6, textTransform:"uppercase", marginBottom:3 }}>{m.l}</div>
                    <div style={{ fontSize:13, fontWeight:700, color:"#1A2840" }}>{m.v}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Blockchain Panel */}
            <BlockchainPanel trial={trial}/>

            {/* Request Access Card */}
            <div className="card" style={{ padding:"22px 22px", border:"1.5px solid #D5E2F8", background:"linear-gradient(135deg,#F7FAFF,#EDF3FC)" }}>
              <div style={{ display:"flex", alignItems:"center", gap:8, marginBottom:14 }}>
                <div style={{ width:32, height:32, borderRadius:8, background:"#1A2840", display:"flex", alignItems:"center", justifyContent:"center" }}>
                  <span style={{ fontSize:14 }}>üîê</span>
                </div>
                <div style={{ fontSize:13, fontWeight:700, color:"#1A2840" }}>Request Full Access</div>
              </div>
              <p style={{ fontSize:12, color:"#5A7090", lineHeight:1.7, marginBottom:18 }}>
                To access detailed patient-level data, statistical analyses, and raw datasets.
              </p>
              <button
                onClick={() => setShowAccess(true)}
                style={{ width:"100%", padding:"12px", borderRadius:10, background:"linear-gradient(135deg,#1A2840,#253855)", color:"white", border:"none", fontWeight:700, fontSize:13, cursor:"pointer", display:"flex", alignItems:"center", justifyContent:"center", gap:8 }}
              >
                üîê REQUEST FULL ACCESS
              </button>
            </div>
          </div>
        </div>

        {/* Footer Links */}
        <div className="footer-links">
          <a href="help.html">Help</a>
          <a href="privacy.html">Privacy</a>
          <a href="terms.html">Terms</a>
          <a href="contact.html">Contact</a>
        </div>
      </main>

      {/* Footer */}
      <footer style={{ background:"#0C1624", padding:"52px 40px 32px", width:"100%" }}>
        <div style={{ maxWidth:1440, margin:"0 auto", display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:16 }}>
          <div style={{ display:"flex", alignItems:"center", gap:10 }}>
            <ShieldLogo size={28}/>
            <span style={{ fontFamily:"'Sora',sans-serif", fontSize:18, fontWeight:800, color:"white", letterSpacing:-0.5 }}>
              WIS<span style={{ color:"#4567B7" }}>ER</span>
            </span>
          </div>
          <div style={{ display:"flex", gap:28 }}>
            <a href="home.html" style={{ fontSize:12, color:"rgba(255,255,255,0.4)", textDecoration:"none" }}>Home</a>
            <a href="privacy.html" style={{ fontSize:12, color:"rgba(255,255,255,0.4)", textDecoration:"none" }}>Privacy</a>
            <a href="terms.html" style={{ fontSize:12, color:"rgba(255,255,255,0.4)", textDecoration:"none" }}>Terms</a>
            <a href="contact.html" style={{ fontSize:12, color:"rgba(255,255,255,0.4)", textDecoration:"none" }}>Contact</a>
          </div>
          <div style={{ display:"flex", alignItems:"center", gap:6 }}>
            <LiveDot active size={6}/>
            <span style={{ fontSize:11, color:"rgba(255,255,255,0.3)" }}>¬© 2026 VISIOR</span>
          </div>
        </div>
      </footer>

      {showContact && <ContactModal researcher={trial?.researcher} onClose={() => setShowContact(false)}/>}
      {showAccess && <AccessModal trialId={trial?.id} onClose={() => setShowAccess(false)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>