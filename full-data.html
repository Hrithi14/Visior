<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WISER ‚Äì Full Trial Data Access | CARDIOPROTECT-II</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --primary: #4567B7;
    --primary-dark: #334e96;
    --primary-light: #eef1f9;
    --primary-mid: #d0d9f0;
    --accent-green: #16a34a;
    --accent-green-bg: #f0fdf4;
    --accent-green-border: #bbf7d0;
    --accent-warn: #d97706;
    --accent-warn-bg: #fffbeb;
    --accent-warn-border: #fde68a;
    --accent-danger: #dc2626;
    --accent-danger-bg: #fff5f5;
    --accent-danger-border: #fecaca;
    --accent-amber: #f59e0b;
    --bg: #f7f8fc;
    --card: #ffffff;
    --border: #e2e6f0;
    --text: #1a2035;
    --text-secondary: #5a6480;
    --text-light: #8b94b0;
    --shadow-sm: 0 1px 3px rgba(69,103,183,0.08), 0 1px 2px rgba(0,0,0,0.04);
    --shadow: 0 4px 16px rgba(69,103,183,0.10), 0 1px 4px rgba(0,0,0,0.04);
    --shadow-lg: 0 8px 32px rgba(69,103,183,0.14), 0 2px 8px rgba(0,0,0,0.06);
    --radius: 12px;
    --radius-sm: 8px;
    --radius-xs: 6px;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
    line-height: 1.5;
  }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 200;
    box-shadow: var(--shadow-sm);
  }

  .header-left { display: flex; align-items: center; gap: 16px; }

  .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; flex-shrink: 0; cursor: pointer; }

  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 8px rgba(69,103,183,0.3);
  }

  .logo-text { display: flex; flex-direction: column; line-height: 1.1; }
  .logo-text strong { font-size: 16px; font-weight: 700; color: var(--primary); letter-spacing: 0.04em; }
  .logo-text span { font-size: 9.5px; color: var(--text-light); letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500; }

  .header-sep { width: 1px; height: 28px; background: var(--border); }

  .breadcrumb {
    display: flex; align-items: center; gap: 6px;
    font-size: 12.5px; color: var(--text-light);
  }
  .breadcrumb a { color: var(--primary); text-decoration: none; font-weight: 500; cursor: pointer; }
  .breadcrumb a:hover { text-decoration: underline; }
  .breadcrumb .sep { color: var(--border); }
  .breadcrumb .current { color: var(--text); font-weight: 600; }

  .header-right { display: flex; align-items: center; gap: 12px; }

  .chain-status {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 12px;
    background: var(--accent-green-bg);
    border: 1px solid var(--accent-green-border);
    border-radius: 20px;
    font-size: 12px; color: var(--accent-green);
    font-weight: 500;
    font-family: 'DM Mono', monospace;
  }

  .chain-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: #22c55e;
    animation: pulse-dot 2s infinite;
  }

  @keyframes pulse-dot {
    0%,100% { opacity:1; box-shadow: 0 0 0 0 rgba(34,197,94,0.4); }
    50% { opacity:0.8; box-shadow: 0 0 0 5px rgba(34,197,94,0); }
  }

  .profile-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 14px 6px 8px;
    background: var(--primary-light); border: 1px solid var(--primary-mid);
    border-radius: 24px; cursor: pointer;
    transition: background 0.2s; font-weight: 500;
    color: var(--primary-dark); font-size: 13px;
    font-family: 'DM Sans', sans-serif;
  }
  .profile-btn:hover { background: var(--primary-mid); }

  .profile-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: var(--primary); color: white;
    display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700;
  }

  .btn-logout {
    padding: 6px 14px; border-radius: var(--radius-xs);
    border: 1px solid var(--border); background: white;
    font-size: 12.5px; font-weight: 600; color: var(--accent-danger);
    cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.18s;
  }
  .btn-logout:hover { background: var(--accent-danger-bg); border-color: var(--accent-danger-border); }

  .main { max-width: 1440px; margin: 0 auto; padding: 24px 32px 48px; }

  .page-top {
    display: flex; align-items: flex-start; justify-content: space-between;
    gap: 16px; margin-bottom: 20px; flex-wrap: wrap;
  }

  .back-btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: var(--radius-xs);
    border: 1px solid var(--border); background: white;
    font-size: 12.5px; font-weight: 600; color: var(--text-secondary);
    cursor: pointer; font-family: 'DM Sans', sans-serif;
    transition: all 0.18s; text-decoration: none;
  }
  .back-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

  .title-block { flex: 1; }
  .trial-name-display { font-size: 22px; font-weight: 700; color: var(--text); line-height: 1.2; }
  .trial-id-display {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 6px;
    font-family: 'DM Mono', monospace; font-size: 12px;
    color: var(--primary); background: var(--primary-light);
    padding: 3px 10px; border-radius: 5px;
  }

  .security-banner {
    display: flex; align-items: center; gap: 12px;
    padding: 12px 18px;
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-left: 4px solid var(--accent-amber);
    border-radius: var(--radius-sm);
    margin-bottom: 20px;
    animation: fadeUp 0.4s ease;
  }

  .security-banner-icon { font-size: 18px; flex-shrink: 0; }
  .security-banner-text { font-size: 13px; color: #92400e; font-weight: 500; }
  .security-banner-text strong { font-weight: 700; }
  .security-banner-right { margin-left: auto; display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

  .session-badge {
    display: flex; align-items: center; gap: 5px;
    padding: 4px 10px; border-radius: 12px;
    background: #fef3c7; border: 1px solid #fde68a;
    font-size: 11px; font-weight: 600; color: #92400e;
    font-family: 'DM Mono', monospace;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 20px;
    align-items: start;
  }

  .overview-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    position: sticky;
    top: 84px;
  }

  .panel-head {
    padding: 14px 18px;
    border-bottom: 1px solid var(--border);
    background: var(--bg);
    display: flex; align-items: center; justify-content: space-between;
  }

  .panel-title {
    font-size: 13px; font-weight: 700; color: var(--text);
    display: flex; align-items: center; gap: 7px;
  }

  .panel-title::before {
    content: '';
    width: 4px; height: 14px;
    background: var(--primary); border-radius: 2px;
  }

  .overview-list { padding: 4px 0; }

  .ov-row {
    padding: 10px 18px;
    border-bottom: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 2px;
  }
  .ov-row:last-child { border-bottom: none; }

  .ov-label { font-size: 10.5px; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; }
  .ov-value { font-size: 13px; font-weight: 600; color: var(--text); }
  .ov-value.mono { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--primary); }
  .ov-value.green { color: var(--accent-green); }
  .ov-value.budget { font-size: 15px; font-weight: 700; }

  .budget-bar { height: 4px; background: var(--border); border-radius: 2px; margin-top: 5px; overflow: hidden; }
  .budget-fill { height: 100%; background: linear-gradient(90deg, var(--accent-green), #4ade80); border-radius: 2px; }

  .right-col { display: flex; flex-direction: column; gap: 20px; }

  .data-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .data-card-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    gap: 12px; flex-wrap: wrap;
    background: var(--bg);
  }

  .data-card-head-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }

  .search-box {
    display: flex; align-items: center; gap: 8px;
    padding: 7px 12px;
    background: white; border: 1px solid var(--border);
    border-radius: var(--radius-xs);
    transition: border-color 0.18s;
  }
  .search-box:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(69,103,183,0.08); }
  .search-box input {
    border: none; outline: none; font-size: 13px;
    font-family: 'DM Sans', sans-serif; color: var(--text);
    width: 200px; background: transparent;
  }
  .search-box input::placeholder { color: var(--text-light); }

  .filter-select {
    padding: 7px 10px; border: 1px solid var(--border);
    border-radius: var(--radius-xs); font-size: 13px;
    font-family: 'DM Sans', sans-serif; color: var(--text);
    background: white; cursor: pointer; outline: none;
    transition: border-color 0.18s;
  }
  .filter-select:focus { border-color: var(--primary); }

  .data-card-head-right { display: flex; align-items: center; gap: 8px; }

  .btn {
    display: inline-flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: var(--radius-xs);
    font-size: 12.5px; font-weight: 600;
    cursor: pointer; border: none;
    transition: all 0.18s;
    font-family: 'DM Sans', sans-serif;
    white-space: nowrap;
  }
  .btn:disabled { opacity: 0.6; cursor: not-allowed; }

  .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 6px rgba(69,103,183,0.28); }
  .btn-primary:hover:not(:disabled) { background: var(--primary-dark); }

  .btn-ghost { background: white; color: var(--text); border: 1px solid var(--border); }
  .btn-ghost:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

  .btn-danger { background: var(--accent-danger-bg); color: var(--accent-danger); border: 1px solid var(--accent-danger-border); }
  .btn-danger:hover:not(:disabled) { background: #fee2e2; }

  .btn-export { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
  .btn-export:hover:not(:disabled) { background: #dcfce7; }

  .spinner {
    display: none; width: 12px; height: 12px;
    border: 2px solid currentColor; border-top-color: transparent;
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  .table-wrap { overflow-x: auto; }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }

  thead tr {
    background: var(--bg);
    border-bottom: 2px solid var(--border);
  }

  thead th {
    padding: 11px 14px;
    text-align: left;
    font-size: 11px; font-weight: 700;
    color: var(--text-light);
    text-transform: uppercase; letter-spacing: 0.06em;
    white-space: nowrap;
    cursor: pointer; user-select: none;
    transition: color 0.15s;
  }
  thead th:hover { color: var(--primary); }
  thead th.sorted { color: var(--primary); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--primary-light); }

  tbody td {
    padding: 12px 14px;
    color: var(--text);
    vertical-align: middle;
  }

  .td-id {
    font-family: 'DM Mono', monospace;
    font-size: 12px; color: var(--primary);
    background: var(--primary-light);
    padding: 2px 7px; border-radius: 4px;
    display: inline-block;
  }

  .td-name { font-weight: 600; }
  .td-dob { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text-secondary); }
  .td-contact { font-size: 12px; color: var(--text-secondary); }

  .outcome-pill {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 9px; border-radius: 12px;
    font-size: 11.5px; font-weight: 600;
  }
  .outcome-pill::before { content:''; width:5px; height:5px; border-radius:50%; background:currentColor; }
  .outcome-improved { background: #f0fdf4; color: #16a34a; }
  .outcome-stable   { background: #eff6ff; color: var(--primary); }
  .outcome-adverse  { background: #fff5f5; color: var(--accent-danger); }
  .outcome-pending  { background: #fefce8; color: var(--accent-warn); }
  .outcome-withdrawn{ background: #f8fafc; color: #64748b; }

  .consent-pill {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 3px 9px; border-radius: 12px;
    font-size: 11.5px; font-weight: 600;
  }
  .consent-yes { background: #f0fdf4; color: #16a34a; }
  .consent-no  { background: #fff5f5; color: var(--accent-danger); }
  .consent-pending { background: #fefce8; color: var(--accent-warn); }

  .chain-confirm {
    display: inline-flex; align-items: center; gap: 4px;
    font-size: 11px; font-weight: 600;
    font-family: 'DM Mono', monospace;
  }
  .chain-confirm-dot { width: 7px; height: 7px; border-radius: 50%; }
  .confirmed { color: #16a34a; }
  .confirmed .chain-confirm-dot { background: #22c55e; animation: pulse-dot 2s infinite; }
  .pending-chain { color: var(--accent-warn); }
  .pending-chain .chain-confirm-dot { background: var(--accent-amber); }

  .row-actions { display: flex; align-items: center; gap: 6px; }

  .icon-btn {
    width: 28px; height: 28px;
    border-radius: var(--radius-xs);
    border: 1px solid var(--border);
    background: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px;
    transition: all 0.15s;
  }
  .icon-btn:hover { background: var(--primary-light); border-color: var(--primary); }
  .icon-btn.del:hover { background: var(--accent-danger-bg); border-color: var(--accent-danger-border); }

  .pagination {
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
    background: var(--bg);
    flex-wrap: wrap; gap: 10px;
  }

  .pagination-info { font-size: 12.5px; color: var(--text-secondary); }
  .pagination-controls { display: flex; align-items: center; gap: 4px; }

  .page-btn {
    min-width: 32px; height: 32px; padding: 0 8px;
    border-radius: var(--radius-xs);
    border: 1px solid var(--border);
    background: white; font-size: 12.5px; font-weight: 500;
    color: var(--text-secondary); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .page-btn:hover:not(:disabled) { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }
  .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); font-weight: 700; }
  .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .chain-panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .chain-feed { max-height: 220px; overflow-y: auto; }

  .chain-entry {
    padding: 10px 18px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  .chain-entry:last-child { border-bottom: none; }
  .chain-entry:hover { background: var(--bg); }
  .chain-entry-top { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; }
  .chain-action-lbl { font-size: 12px; font-weight: 600; color: var(--text); }
  .chain-time-lbl { font-size: 11px; color: var(--text-light); }
  .chain-hash-val {
    font-family: 'DM Mono', monospace; font-size: 10.5px;
    color: var(--primary); background: var(--primary-light);
    padding: 2px 6px; border-radius: 4px; display: inline-block;
  }
  .chain-block-val { font-size: 10.5px; color: var(--text-light); margin-top: 2px; }

  .modal-backdrop {
    display: none; position: fixed; inset: 0;
    background: rgba(26,32,53,0.5);
    z-index: 500; backdrop-filter: blur(3px);
    align-items: center; justify-content: center;
  }
  .modal-backdrop.open { display: flex; }

  .modal {
    background: var(--card); border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    width: 480px; max-width: calc(100vw - 32px);
    max-height: 90vh; overflow-y: auto;
    animation: modalIn 0.25s ease;
  }
  @keyframes modalIn {
    from { opacity:0; transform: scale(0.96) translateY(8px); }
    to   { opacity:1; transform: scale(1) translateY(0); }
  }

  .modal-head {
    padding: 18px 22px 14px;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .modal-title { font-size: 16px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 8px; }
  .modal-close { background: none; border: none; cursor: pointer; font-size: 18px; color: var(--text-light); padding: 2px; transition: color 0.15s; }
  .modal-close:hover { color: var(--text); }

  .modal-body { padding: 20px 22px; }

  .modal-field { margin-bottom: 16px; }
  .modal-field label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.04em; }
  .modal-field input, .modal-field select {
    width: 100%; padding: 9px 12px;
    border: 1px solid var(--border); border-radius: var(--radius-xs);
    font-size: 13px; font-family: 'DM Sans', sans-serif;
    color: var(--text); background: white; outline: none;
    transition: border-color 0.18s;
  }
  .modal-field input:focus, .modal-field select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(69,103,183,0.1);
  }

  .modal-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .modal-foot {
    padding: 14px 22px;
    border-top: 1px solid var(--border);
    display: flex; justify-content: flex-end; gap: 8px;
    background: var(--bg);
  }

  .confirm-icon { font-size: 40px; text-align: center; margin-bottom: 12px; }
  .confirm-title { font-size: 17px; font-weight: 700; color: var(--text); text-align: center; margin-bottom: 8px; }
  .confirm-msg { font-size: 13px; color: var(--text-secondary); text-align: center; margin-bottom: 16px; }
  .confirm-chain {
    background: var(--primary-light); border: 1px solid var(--primary-mid);
    border-radius: var(--radius-sm); padding: 12px 14px;
  }
  .confirm-chain-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 12px; }
  .confirm-chain-row:last-child { margin-bottom: 0; }
  .confirm-chain-lbl { color: var(--text-light); font-weight: 500; }
  .confirm-chain-val { font-family: 'DM Mono', monospace; color: var(--primary); font-weight: 600; font-size: 11.5px; }

  .toast-container {
    position: fixed; bottom: 24px; right: 24px;
    z-index: 9999; display: flex; flex-direction: column;
    gap: 10px; max-width: 360px;
  }

  .toast {
    background: var(--card); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 13px 16px;
    box-shadow: var(--shadow-lg);
    display: flex; align-items: flex-start; gap: 10px;
    animation: slideIn 0.3s ease;
  }
  @keyframes slideIn { from { transform: translateX(100%); opacity:0; } to { transform: translateX(0); opacity:1; } }

  .toast-icon { font-size: 18px; flex-shrink: 0; }
  .toast-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 2px; }
  .toast-msg { font-size: 12px; color: var(--text-secondary); }
  .toast-hash { font-family: 'DM Mono', monospace; font-size: 10.5px; color: var(--primary); margin-top: 3px; }

  .rt-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; color: var(--accent-green); font-weight: 500; }
  .rt-dot { width: 6px; height: 6px; border-radius: 50%; background: #22c55e; animation: pulse-dot 2s infinite; }

  @keyframes fadeUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
  .fade-up { animation: fadeUp 0.4s ease both; }

  .footer-links {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 30px;
    padding: 20px 0;
    border-top: 1px solid var(--border);
  }

  .footer-links a {
    color: var(--text-light);
    text-decoration: none;
    font-size: 12px;
    transition: color 0.2s;
  }

  .footer-links a:hover {
    color: var(--primary);
  }

  @media (max-width: 1100px) {
    .content-grid { grid-template-columns: 1fr; }
    .overview-panel { position: static; }
  }
  @media (max-width: 640px) {
    .main { padding: 16px; }
    .header { padding: 0 16px; }
    .breadcrumb { display: none; }
    .chain-status { display: none; }
    .data-card-head { flex-direction: column; align-items: stretch; }
    .search-box input { width: 100%; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-left">
    <a href="#" class="logo" onclick="window.location.href='home.html'">
      <div class="logo-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
          <path d="M12 2L4 6v6c0 5.25 3.5 10.15 8 11.5C16.5 22.15 20 17.25 20 12V6L12 2z"/>
          <path d="M9 12l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <div class="logo-text">
        <strong>WISER</strong>
        <span>Verified Intelligent Secure Evidence Registry</span>
      </div>
    </a>
    <div class="header-sep"></div>
    <nav class="breadcrumb">
      <a href="#" onclick="window.location.href='home.html'">WISER</a>
      <span class="sep">‚Ä∫</span>
      <a href="#" onclick="window.location.href='pi-dashboard.html'">My Trials</a>
      <span class="sep">‚Ä∫</span>
      <a href="#" onclick="window.location.href='pi-dashboard.html'">WISER-2024-003</a>
      <span class="sep">‚Ä∫</span>
      <span class="current">Full Data Access</span>
    </nav>
  </div>
  <div class="header-right">
    <div class="chain-status">
      <div class="chain-dot"></div>
      <span>Hyperledger Fabric ¬∑ Block #148,247</span>
    </div>
    <button class="profile-btn" onclick="toggleProfile()">
      <div class="profile-avatar">SS</div>
      Dr. Sarah Smith
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
    <button class="btn-logout" onclick="handleLogout()">Logout</button>
  </div>
</header>

<!-- MAIN -->
<div class="main">

  <div class="page-top fade-up">
    <div>
      <a href="#" class="back-btn" onclick="window.location.href='pi-dashboard.html'">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
        Back to Dashboard
      </a>
    </div>
    <div class="title-block">
      <div class="trial-name-display">CARDIOPROTECT-II: Cardioprotective Effects of Novel ACE Inhibitor in Post-MI Patients</div>
      <div>
        <span class="trial-id-display">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 12h6M9 15h4"/></svg>
          WISER-2024-003
        </span>
      </div>
    </div>
    <span class="rt-badge"><span class="rt-dot"></span> Live data sync</span>
  </div>

  <!-- SECURITY BANNER -->
  <div class="security-banner fade-up">
    <div class="security-banner-icon">‚ö†Ô∏è</div>
    <div class="security-banner-text">
      <strong>Sensitive Data ‚Äì Contains patient identifiers.</strong>
      All access, edits, exports, and deletions are cryptographically hashed and permanently recorded on the Hyperledger Fabric blockchain. Unauthorized use is a violation of HIPAA, 21 CFR Part 11, and institutional policy.
    </div>
    <div class="security-banner-right">
      <div class="session-badge">üîí SESSION ACTIVE ¬∑ TIER 3</div>
    </div>
  </div>

  <!-- CONTENT GRID -->
  <div class="content-grid">

    <!-- LEFT: OVERVIEW PANEL -->
    <div>
      <div class="overview-panel fade-up">
        <div class="panel-head">
          <span class="panel-title">Trial Overview</span>
          <span style="font-size:11px;color:var(--text-light);">WISER-2024-003</span>
        </div>
        <div class="overview-list">
          <div class="ov-row">
            <div class="ov-label">Trial ID</div>
            <div class="ov-value mono">WISER-2024-003</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">IRB Protocol Number</div>
            <div class="ov-value mono">IRB-2024-MGH-0847</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">FDA IND Number</div>
            <div class="ov-value mono">IND-142857</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">ClinicalTrials.gov ID</div>
            <div class="ov-value mono" style="color:#0369a1;">NCT05784231</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Sponsor</div>
            <div class="ov-value">Massachusetts General Hospital</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Contract Number</div>
            <div class="ov-value mono">MGH-CTR-2024-003</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Grant Number</div>
            <div class="ov-value mono">NIH-R01-HL-184920</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Total Budget</div>
            <div class="ov-value budget">$4,850,000</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Remaining Budget</div>
            <div class="ov-value green budget">$2,341,200</div>
            <div class="budget-bar"><div class="budget-fill" style="width:48.3%"></div></div>
          </div>
          <div class="ov-row">
            <div class="ov-label">PI</div>
            <div class="ov-value">Dr. Sarah Smith, MD, PhD</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Phase</div>
            <div class="ov-value">Phase III Randomized Controlled Trial</div>
          </div>
          <div class="ov-row">
            <div class="ov-label">Enrollment Status</div>
            <div class="ov-value" style="color:var(--accent-green);">‚óè Active ¬∑ 342 / 500</div>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN -->
    <div class="right-col">

      <!-- PATIENT DATA TABLE -->
      <div class="data-card fade-up">
        <div class="data-card-head">
          <div class="data-card-head-left">
            <div class="panel-title" style="margin:0 0 0 2px;">
              Patient Data
              <span style="background:var(--primary);color:white;padding:1px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:6px;" id="patient-count">12</span>
            </div>
            <div class="search-box">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8b94b0" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
              <input type="text" id="search-input" placeholder="Search patients..." oninput="filterTable()">
            </div>
            <select class="filter-select" id="outcome-filter" onchange="filterTable()">
              <option value="">All Outcomes</option>
              <option value="Improved">Improved</option>
              <option value="Stable">Stable</option>
              <option value="Adverse Event">Adverse Event</option>
              <option value="Pending">Pending</option>
              <option value="Withdrawn">Withdrawn</option>
            </select>
            <select class="filter-select" id="consent-filter" onchange="filterTable()">
              <option value="">All Consent</option>
              <option value="Consented">Consented</option>
              <option value="Pending">Pending</option>
              <option value="Withdrawn">Withdrawn</option>
            </select>
          </div>
          <div class="data-card-head-right">
            <button class="btn btn-export" onclick="handleExport(this)">
              <span class="spinner"></span>
              üîê Export Encrypted
            </button>
            <button class="btn btn-primary" onclick="openAddModal()">
              <span class="spinner"></span>
              ‚ûï Add Patient
            </button>
          </div>
        </div>

        <div class="table-wrap">
          <table id="patient-table">
            <thead>
              <tr>
                <th onclick="sortTable('id')">Patient ID <span class="sort-icon">‚Üï</span></th>
                <th onclick="sortTable('name')">Full Name <span class="sort-icon">‚Üï</span></th>
                <th onclick="sortTable('dob')">Date of Birth <span class="sort-icon">‚Üï</span></th>
                <th>Age</th>
                <th>Gender</th>
                <th>Contact</th>
                <th onclick="sortTable('outcome')">Outcome <span class="sort-icon">‚Üï</span></th>
                <th>Consent</th>
                <th>Blockchain</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="table-body"></tbody>
          </table>
        </div>

        <div class="pagination">
          <div class="pagination-info" id="page-info">Showing 1‚Äì10 of 12 patients</div>
          <div class="pagination-controls" id="page-controls"></div>
        </div>
      </div>

      <!-- BLOCKCHAIN LOG -->
      <div class="chain-panel fade-up">
        <div class="panel-head">
          <span class="panel-title">‚õì Blockchain Audit Log</span>
          <span style="font-size:11px;color:var(--text-light);font-family:'DM Mono',monospace;">Hyperledger Fabric ¬∑ WISER-2024-003</span>
        </div>
        <div class="chain-feed" id="chain-feed">
          <div class="chain-entry">
            <div class="chain-entry-top"><span class="chain-action-lbl">Full Data Access ‚Äì PI View</span><span class="chain-time-lbl">Just now</span></div>
            <div class="chain-hash-val">0x4c2e9ab3f81d...7f3a</div>
            <div class="chain-block-val">Block #148,247 ¬∑ Dr. Sarah Smith ¬∑ TIER-3</div>
          </div>
          <div class="chain-entry">
            <div class="chain-entry-top"><span class="chain-action-lbl">Patient Data Updated ‚Äì P0339</span><span class="chain-time-lbl">14 min ago</span></div>
            <div class="chain-hash-val">0x8d1f3ca2e907...2b8c</div>
            <div class="chain-block-val">Block #148,231 ¬∑ Outcome modified</div>
          </div>
          <div class="chain-entry">
            <div class="chain-entry-top"><span class="chain-action-lbl">Patient Data Added ‚Äì P0342</span><span class="chain-time-lbl">1 hour ago</span></div>
            <div class="chain-hash-val">0x3fa8b2c1d9e7...4a2c</div>
            <div class="chain-block-val">Block #148,204 ¬∑ New enrollment</div>
          </div>
          <div class="chain-entry">
            <div class="chain-entry-top"><span class="chain-action-lbl">Consent Updated ‚Äì P0318</span><span class="chain-time-lbl">3 hours ago</span></div>
            <div class="chain-hash-val">0x9c21a8f3e47b...8d01</div>
            <div class="chain-block-val">Block #148,119 ¬∑ Consent withdrawn</div>
          </div>
          <div class="chain-entry">
            <div class="chain-entry-top"><span class="chain-action-lbl">SAE Flagged ‚Äì P0295</span><span class="chain-time-lbl">Yesterday</span></div>
            <div class="chain-hash-val">0x6b4e7d2af180...c39f</div>
            <div class="chain-block-val">Block #147,990 ¬∑ Adverse event grade 3</div>
          </div>
        </div>
      </div>

    </div>
  </div>
  
  <!-- Footer Links -->
  <div class="footer-links">
    <a href="help.html">Help</a>
    <a href="privacy.html">Privacy</a>
    <a href="terms.html">Terms</a>
    <a href="contact.html">Contact</a>
  </div>
</div>

<!-- ADD/EDIT MODAL -->
<div class="modal-backdrop" id="form-modal">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="modal-title">‚ûï Add New Patient</div>
      <button class="modal-close" onclick="closeModal('form-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="modal-row">
        <div class="modal-field">
          <label>Patient ID</label>
          <input type="text" id="f-id" placeholder="e.g. P0343" />
        </div>
        <div class="modal-field">
          <label>Gender</label>
          <select id="f-gender">
            <option>Male</option><option>Female</option><option>Non-binary</option><option>Prefer not to say</option>
          </select>
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>First Name</label>
          <input type="text" id="f-fname" placeholder="First name" />
        </div>
        <div class="modal-field">
          <label>Last Name</label>
          <input type="text" id="f-lname" placeholder="Last name" />
        </div>
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>Date of Birth</label>
          <input type="date" id="f-dob" />
        </div>
        <div class="modal-field">
          <label>Phone</label>
          <input type="text" id="f-phone" placeholder="+1 (555) 000-0000" />
        </div>
      </div>
      <div class="modal-field">
        <label>Email</label>
        <input type="email" id="f-email" placeholder="patient@email.com" />
      </div>
      <div class="modal-row">
        <div class="modal-field">
          <label>Outcome</label>
          <select id="f-outcome">
            <option>Improved</option><option>Stable</option><option>Adverse Event</option><option>Pending</option><option>Withdrawn</option>
          </select>
        </div>
        <div class="modal-field">
          <label>Consent Status</label>
          <select id="f-consent">
            <option>Consented</option><option>Pending</option><option>Withdrawn</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('form-modal')">Cancel</button>
      <button class="btn btn-primary" id="modal-save-btn" onclick="savePatient()">
        <span class="spinner" id="modal-spinner"></span>
        Save & Record on Blockchain
      </button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal-backdrop" id="confirm-modal">
  <div class="modal" style="max-width:420px;">
    <div class="modal-head">
      <div class="modal-title">‚úÖ Action Confirmed</div>
      <button class="modal-close" onclick="closeModal('confirm-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="confirm-icon" id="confirm-icon">‚úÖ</div>
      <div class="confirm-title" id="confirm-title">Action Complete</div>
      <div class="confirm-msg" id="confirm-msg">Recorded on blockchain.</div>
      <div class="confirm-chain">
        <div class="confirm-chain-row">
          <span class="confirm-chain-lbl">Transaction Hash</span>
          <span class="confirm-chain-val" id="c-hash">‚Äî</span>
        </div>
        <div class="confirm-chain-row">
          <span class="confirm-chain-lbl">Block Number</span>
          <span class="confirm-chain-val" id="c-block">‚Äî</span>
        </div>
        <div class="confirm-chain-row">
          <span class="confirm-chain-lbl">Transaction ID</span>
          <span class="confirm-chain-val" id="c-txid">‚Äî</span>
        </div>
        <div class="confirm-chain-row">
          <span class="confirm-chain-lbl">Channel</span>
          <span class="confirm-chain-val">wiser-trials-channel</span>
        </div>
        <div class="confirm-chain-row">
          <span class="confirm-chain-lbl">Status</span>
          <span class="confirm-chain-val" style="color:var(--accent-green);">‚úì CONFIRMED</span>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-primary" onclick="closeModal('confirm-modal')">Done</button>
    </div>
  </div>
</div>

<!-- DELETE MODAL -->
<div class="modal-backdrop" id="delete-modal">
  <div class="modal" style="max-width:400px;">
    <div class="modal-head">
      <div class="modal-title" style="color:var(--accent-danger);">üóë Delete Patient Record</div>
      <button class="modal-close" onclick="closeModal('delete-modal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="confirm-icon">‚ö†Ô∏è</div>
      <div class="confirm-title">Confirm Deletion</div>
      <div class="confirm-msg">You are about to delete patient <strong id="del-name"></strong>. This action will be permanently recorded on the blockchain and cannot be undone.</div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-ghost" onclick="closeModal('delete-modal')">Cancel</button>
      <button class="btn btn-danger" id="del-confirm-btn" onclick="confirmDelete()">
        <span class="spinner" id="del-spinner"></span>
        Delete & Log on Blockchain
      </button>
    </div>
  </div>
</div>

<div class="toast-container" id="toast-container"></div>

<script>
let patients = [
  { id:'P0301', fname:'James',    lname:'Harrison',  dob:'1958-04-12', gender:'Male',   phone:'+1 (617) 555-0182', email:'j.harrison@email.com',  outcome:'Improved',      consent:'Consented', chain:'confirmed' },
  { id:'P0307', fname:'Margaret', lname:'Sullivan',  dob:'1965-09-23', gender:'Female', phone:'+1 (617) 555-0247', email:'m.sullivan@email.com',   outcome:'Stable',        consent:'Consented', chain:'confirmed' },
  { id:'P0312', fname:'Robert',   lname:'Chen',      dob:'1952-02-07', gender:'Male',   phone:'+1 (508) 555-0391', email:'r.chen@email.com',       outcome:'Improved',      consent:'Consented', chain:'confirmed' },
  { id:'P0318', fname:'Patricia', lname:'Williams',  dob:'1970-11-30', gender:'Female', phone:'+1 (781) 555-0156', email:'p.williams@email.com',   outcome:'Withdrawn',     consent:'Withdrawn', chain:'confirmed' },
  { id:'P0321', fname:'Thomas',   lname:"O'Brien",   dob:'1960-06-14', gender:'Male',   phone:'+1 (617) 555-0478', email:'t.obrien@email.com',     outcome:'Stable',        consent:'Consented', chain:'confirmed' },
  { id:'P0327', fname:'Barbara',  lname:'Martinez',  dob:'1955-08-19', gender:'Female', phone:'+1 (617) 555-0593', email:'b.martinez@email.com',   outcome:'Improved',      consent:'Consented', chain:'confirmed' },
  { id:'P0334', fname:'Michael',  lname:'Thompson',  dob:'1968-03-05', gender:'Male',   phone:'+1 (508) 555-0267', email:'m.thompson@email.com',   outcome:'Adverse Event', consent:'Consented', chain:'confirmed' },
  { id:'P0339', fname:'Linda',    lname:'Davis',     dob:'1963-12-28', gender:'Female', phone:'+1 (781) 555-0384', email:'l.davis@email.com',      outcome:'Pending',       consent:'Consented', chain:'pending'   },
  { id:'P0341', fname:'William',  lname:'Anderson',  dob:'1957-07-16', gender:'Male',   phone:'+1 (617) 555-0712', email:'w.anderson@email.com',   outcome:'Stable',        consent:'Consented', chain:'confirmed' },
  { id:'P0342', fname:'Jennifer', lname:'Robinson',  dob:'1972-01-09', gender:'Female', phone:'+1 (617) 555-0831', email:'j.robinson@email.com',   outcome:'Pending',       consent:'Consented', chain:'pending'   },
  { id:'P0295', fname:'David',    lname:'Lee',       dob:'1949-05-22', gender:'Male',   phone:'+1 (508) 555-0149', email:'d.lee@email.com',        outcome:'Adverse Event', consent:'Consented', chain:'confirmed' },
  { id:'P0482', fname:'Susan',    lname:'Taylor',    dob:'1961-10-03', gender:'Female', phone:'+1 (617) 555-0965', email:'s.taylor@email.com',     outcome:'Adverse Event', consent:'Consented', chain:'pending'   },
];

let filteredPatients = [...patients];
let currentPage = 1;
const perPage = 10;
let sortKey = '';
let sortDir = 1;
let editingId = null;
let deletingId = null;

function calcAge(dob) {
  const d = new Date(dob), now = new Date();
  let a = now.getFullYear() - d.getFullYear();
  if (now < new Date(now.getFullYear(), d.getMonth(), d.getDate())) a--;
  return a;
}

function generateHash() {
  const c='0123456789abcdef'; let h='0x';
  for(let i=0;i<12;i++) h+=c[Math.floor(Math.random()*16)];
  h+='...'+Array.from({length:4},()=>c[Math.floor(Math.random()*16)]).join('');
  return h;
}
function generateBlock() { return (148204+Math.floor(Math.random()*200)).toLocaleString(); }
function generateTxId() { return 'TX-'+Date.now().toString(36).toUpperCase()+'-'+Math.random().toString(36).substr(2,5).toUpperCase(); }

function outcomeClass(o) {
  const m={'Improved':'improved','Stable':'stable','Adverse Event':'adverse','Pending':'pending','Withdrawn':'withdrawn'};
  return 'outcome-'+(m[o]||'pending');
}
function consentClass(c) {
  const m={'Consented':'yes','Withdrawn':'no','Pending':'pending'};
  return 'consent-'+(m[c]||'pending');
}

function renderTable() {
  const tbody = document.getElementById('table-body');
  const start = (currentPage-1)*perPage;
  const page  = filteredPatients.slice(start, start+perPage);

  tbody.innerHTML = page.map(p => {
    const age = calcAge(p.dob);
    const dobFmt = new Date(p.dob).toLocaleDateString('en-US',{month:'short',day:'2-digit',year:'numeric'});
    const chainHtml = p.chain==='confirmed'
      ? `<span class="chain-confirm confirmed"><span class="chain-confirm-dot"></span>Confirmed</span>`
      : `<span class="chain-confirm pending-chain"><span class="chain-confirm-dot"></span>Pending</span>`;
    return `
      <tr data-id="${p.id}">
        <td><span class="td-id">${p.id}</span></td>
        <td class="td-name">${p.fname} ${p.lname}</td>
        <td class="td-dob">${dobFmt}</td>
        <td style="text-align:center;font-weight:600;">${age}</td>
        <td>${p.gender}</td>
        <td class="td-contact"><div>${p.phone}</div><div style="font-size:11.5px;color:var(--text-light);">${p.email}</div></td>
        <td><span class="outcome-pill ${outcomeClass(p.outcome)}">${p.outcome}</span></td>
        <td><span class="consent-pill ${consentClass(p.consent)}">${p.consent}</span></td>
        <td>${chainHtml}</td>
        <td><div class="row-actions">
          <button class="icon-btn" title="Edit" onclick="openEditModal('${p.id}')">‚úèÔ∏è</button>
          <button class="icon-btn del" title="Delete" onclick="openDeleteModal('${p.id}')">üóë</button>
        </div></td>
      </tr>`;
  }).join('');

  document.getElementById('patient-count').textContent = filteredPatients.length;
  renderPagination();
}

function renderPagination() {
  const total = filteredPatients.length;
  const pages = Math.ceil(total/perPage);
  const start = (currentPage-1)*perPage+1;
  const end   = Math.min(currentPage*perPage, total);
  document.getElementById('page-info').textContent = `Showing ${start}‚Äì${end} of ${total} patients`;
  const ctrl = document.getElementById('page-controls');
  let html = `<button class="page-btn" onclick="goPage(${currentPage-1})" ${currentPage===1?'disabled':''}>‚Äπ</button>`;
  for(let i=1;i<=pages;i++) html += `<button class="page-btn${i===currentPage?' active':''}" onclick="goPage(${i})">${i}</button>`;
  html += `<button class="page-btn" onclick="goPage(${currentPage+1})" ${currentPage===pages||pages===0?'disabled':''}>‚Ä∫</button>`;
  ctrl.innerHTML = html;
}

function goPage(n) {
  const pages = Math.ceil(filteredPatients.length/perPage);
  if(n<1||n>pages) return;
  currentPage=n; renderTable();
}

function filterTable() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const oc = document.getElementById('outcome-filter').value;
  const cc = document.getElementById('consent-filter').value;
  filteredPatients = patients.filter(p => {
    const hay = `${p.id} ${p.fname} ${p.lname} ${p.email} ${p.phone}`.toLowerCase();
    return (!q||hay.includes(q)) && (!oc||p.outcome===oc) && (!cc||p.consent===cc);
  });
  currentPage=1; renderTable();
}

function sortTable(key) {
  if(sortKey===key) sortDir*=-1; else { sortKey=key; sortDir=1; }
  filteredPatients.sort((a,b) => {
    let av=a[key]||'', bv=b[key]||'';
    return av<bv ? -sortDir : av>bv ? sortDir : 0;
  });
  renderTable();
}

function openAddModal() {
  editingId=null;
  document.getElementById('modal-title').textContent='‚ûï Add New Patient';
  ['f-id','f-fname','f-lname','f-dob','f-phone','f-email'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('f-gender').value='Male';
  document.getElementById('f-outcome').value='Pending';
  document.getElementById('f-consent').value='Consented';
  document.getElementById('form-modal').classList.add('open');
}

function openEditModal(pid) {
  editingId=pid;
  const p=patients.find(x=>x.id===pid); if(!p) return;
  document.getElementById('modal-title').textContent='‚úèÔ∏è Edit Patient ‚Äì '+pid;
  document.getElementById('f-id').value=p.id;
  document.getElementById('f-fname').value=p.fname;
  document.getElementById('f-lname').value=p.lname;
  document.getElementById('f-dob').value=p.dob;
  document.getElementById('f-phone').value=p.phone;
  document.getElementById('f-email').value=p.email;
  document.getElementById('f-gender').value=p.gender;
  document.getElementById('f-outcome').value=p.outcome;
  document.getElementById('f-consent').value=p.consent;
  document.getElementById('form-modal').classList.add('open');
}

async function savePatient() {
  const btn=document.getElementById('modal-save-btn');
  const sp=document.getElementById('modal-spinner');
  btn.disabled=true; sp.style.display='inline-block';
  await delay(1400);
  btn.disabled=false; sp.style.display='none';

  const newP = {
    id:      document.getElementById('f-id').value||'P0'+(300+patients.length+1),
    fname:   document.getElementById('f-fname').value||'Unknown',
    lname:   document.getElementById('f-lname').value||'Patient',
    dob:     document.getElementById('f-dob').value||'1970-01-01',
    gender:  document.getElementById('f-gender').value,
    phone:   document.getElementById('f-phone').value||'+1 (617) 555-0000',
    email:   document.getElementById('f-email').value||'patient@email.com',
    outcome: document.getElementById('f-outcome').value,
    consent: document.getElementById('f-consent').value,
    chain:   'pending',
  };

  if(editingId) {
    const idx=patients.findIndex(x=>x.id===editingId);
    if(idx>=0) patients[idx]={...patients[idx],...newP,id:patients[idx].id};
  } else {
    patients.unshift(newP);
  }

  filteredPatients=[...patients]; renderTable();
  closeModal('form-modal');

  const hash=generateHash(), block=generateBlock(), txId=generateTxId();
  showConfirm(editingId?'Patient Record Updated':'Patient Added','Record encrypted and logged on Hyperledger Fabric.',hash,block,txId);
  addChainEntry(editingId?`Patient Updated ‚Äì ${newP.id}`:`Patient Added ‚Äì ${newP.id}`,hash,block);
  showToast('‚úÖ',editingId?'Record Updated':'Patient Added',`${newP.fname} ${newP.lname} ¬∑ ${newP.id}`,hash);

  setTimeout(()=>{
    const idx=patients.findIndex(x=>x.id===newP.id);
    if(idx>=0){ patients[idx].chain='confirmed'; filteredPatients=[...patients]; renderTable(); }
  },3000);
}

function openDeleteModal(pid) {
  deletingId=pid;
  const p=patients.find(x=>x.id===pid); if(!p) return;
  document.getElementById('del-name').textContent=`${p.fname} ${p.lname} (${p.id})`;
  document.getElementById('delete-modal').classList.add('open');
}

async function confirmDelete() {
  const btn=document.getElementById('del-confirm-btn');
  const sp=document.getElementById('del-spinner');
  btn.disabled=true; sp.style.display='inline-block';
  await delay(1200);
  btn.disabled=false; sp.style.display='none';

  const p=patients.find(x=>x.id===deletingId);
  patients=patients.filter(x=>x.id!==deletingId);
  filteredPatients=[...patients]; renderTable();
  closeModal('delete-modal');

  const hash=generateHash(), block=generateBlock(), txId=generateTxId();
  showConfirm('Patient Record Deleted','Deletion permanently recorded. Immutably audited on blockchain.',hash,block,txId,'‚ö†Ô∏è');
  addChainEntry(`Patient Deleted ‚Äì ${deletingId}`,hash,block);
  showToast('üóë','Record Deleted',`${p?.fname} ${p?.lname} ¬∑ ${deletingId}`,hash);
}

async function handleExport(btn) {
  const sp=btn.querySelector('.spinner');
  btn.disabled=true; sp.style.display='inline-block';
  await delay(2000);
  btn.disabled=false; sp.style.display='none';
  const hash=generateHash(), block=generateBlock(), txId=generateTxId();
  showConfirm('Encrypted Export Complete','Dataset exported with AES-256 encryption. Export logged on blockchain.',hash,block,txId,'üîê');
  addChainEntry('Encrypted Export ‚Äì Full Dataset',hash,block);
  showToast('üîê','Export Ready','AES-256 encrypted dataset prepared',hash);
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

function showConfirm(title,msg,hash,block,txId,icon='‚úÖ') {
  document.getElementById('confirm-icon').textContent=icon;
  document.getElementById('confirm-title').textContent=title;
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('c-hash').textContent=hash;
  document.getElementById('c-block').textContent='#'+block;
  document.getElementById('c-txid').textContent=txId;
  document.getElementById('confirm-modal').classList.add('open');
}

function addChainEntry(action,hash,block) {
  const feed=document.getElementById('chain-feed');
  const el=document.createElement('div');
  el.className='chain-entry';
  el.style.background='#f0fdf4';
  el.innerHTML=`
    <div class="chain-entry-top"><span class="chain-action-lbl">${action}</span><span class="chain-time-lbl">Just now</span></div>
    <div class="chain-hash-val">${hash}</div>
    <div class="chain-block-val">Block #${block} ¬∑ Dr. Sarah Smith</div>`;
  feed.insertBefore(el,feed.firstChild);
  setTimeout(()=>{ el.style.background=''; },2500);
}

function showToast(icon,title,msg,hash) {
  const c=document.getElementById('toast-container');
  const t=document.createElement('div');
  t.className='toast';
  t.innerHTML=`<div class="toast-icon">${icon}</div><div><div class="toast-title">${title}</div><div class="toast-msg">${msg}</div><div class="toast-hash">${hash}</div></div>`;
  c.appendChild(t);
  setTimeout(()=>{ t.style.animation='slideIn 0.3s ease reverse'; setTimeout(()=>t.remove(),280); },4000);
}

function delay(ms) { return new Promise(r=>setTimeout(r,ms)); }

function handleLogout() {
  if(confirm('Log out of WISER? Your session will be recorded on the audit chain.')) {
    showToast('üîí','Session Terminated','Logout recorded on blockchain',generateHash());
    setTimeout(()=>window.location.href='login.html',1800);
  }
}

function toggleProfile() {
  window.location.href='profile.html';
}

function simulateRealtime() {
  setInterval(()=>{
    const pending=patients.filter(p=>p.chain==='pending');
    if(pending.length && Math.random()<0.5) {
      pending[0].chain='confirmed';
      filteredPatients=[...patients]; renderTable();
      showToast('‚õì','Blockchain Confirmed',`Patient ${pending[0].id} chain status confirmed`,generateHash());
    }
  }, 5000);

  setTimeout(()=>{
    const p=patients.find(x=>x.id==='P0339');
    if(p){ p.consent='Consented'; filteredPatients=[...patients]; renderTable();
      addChainEntry('Real-time Consent Update ‚Äì P0339',generateHash(),generateBlock());
      showToast('üìã','Consent Updated','P0339 ‚Äì Consent confirmed in real time',generateHash());
    }
  }, 10000);

  setTimeout(()=>{
    const newPt={id:'P0343',fname:'Charles',lname:'Brown',dob:'1966-08-17',gender:'Male',phone:'+1 (617) 555-1099',email:'c.brown@email.com',outcome:'Pending',consent:'Consented',chain:'pending'};
    patients.unshift(newPt); filteredPatients=[...patients]; renderTable();
    addChainEntry('Real-time Enrollment ‚Äì P0343',generateHash(),generateBlock());
    showToast('üî¥','New Patient Enrolled','P0343 Charles Brown added in real time',generateHash());
  }, 18000);
}

renderTable();
simulateRealtime();
</script>

</body>
</html>